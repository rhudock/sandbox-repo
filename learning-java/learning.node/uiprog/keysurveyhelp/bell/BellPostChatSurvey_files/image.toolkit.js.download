this["JST"]=this["JST"]||{};this["JST"]["ui/presentation/components/image.toolkit/jst/base.image.template.hbs"]=Handlebars.template({"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var helper;return'\n    <img id="imgPreviewPicture" class="changeImageSrc unselectable" src="'+container.escapeExpression(((helper=(helper=helpers.imageSrc||(depth0!=null?depth0.imageSrc:depth0))!=null?helper:helpers.helperMissing),(typeof helper==="function"?helper.call(depth0!=null?depth0:(container.nullContext||{}),{"name":"imageSrc","hash":{},"data":data}):helper)))+'" alt=""/>\n';},"useData":true});this["JST"]["ui/presentation/components/image.toolkit/jst/crop.toolbar.template.hbs"]=Handlebars.template({"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var helper,alias1=depth0!=null?depth0:(container.nullContext||{}),alias2=helpers.helperMissing,alias3="function",alias4=container.escapeExpression;return'<div class="imageInfoAction">\n    <span class="imgText">'+alias4(((helper=(helper=helpers.cropText||(depth0!=null?depth0.cropText:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropText","hash":{},"data":data}):helper)))+'</span>\n    <span class="imgHint">'+alias4(((helper=(helper=helpers.cropHint||(depth0!=null?depth0.cropHint:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropHint","hash":{},"data":data}):helper)))+'</span>\n</div>\n<div class="toolbarButtonsContainer">\n    <a class="gEditBTN previewButton disabled" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.cropPreviewButton||(depth0!=null?depth0.cropPreviewButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropPreviewButton","hash":{},"data":data}):helper)))+'">'+alias4(((helper=(helper=helpers.cropPreviewButton||(depth0!=null?depth0.cropPreviewButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropPreviewButton","hash":{},"data":data}):helper)))+'</a>\n    <a class="gEditBTN undoButton clearButton disabled" title="'+alias4(((helper=(helper=helpers.cropUndoButton||(depth0!=null?depth0.cropUndoButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropUndoButton","hash":{},"data":data}):helper)))+'" href="javascript:void(0);"><b></b></a>\n    <a class="gEditBTN cancelButton" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.cropCancelButton||(depth0!=null?depth0.cropCancelButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropCancelButton","hash":{},"data":data}):helper)))+'"> <b></b><span>'+alias4(((helper=(helper=helpers.cropCancelButton||(depth0!=null?depth0.cropCancelButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropCancelButton","hash":{},"data":data}):helper)))+'</span></a>\n    <a class="gEditBTN saveButton disabled" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.saveButton||(depth0!=null?depth0.saveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"saveButton","hash":{},"data":data}):helper)))+" "+alias4(((helper=(helper=helpers.cropSaveButton||(depth0!=null?depth0.cropSaveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropSaveButton","hash":{},"data":data}):helper)))+'">'+alias4(((helper=(helper=helpers.saveButton||(depth0!=null?depth0.saveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"saveButton","hash":{},"data":data}):helper)))+" <span>"+alias4(((helper=(helper=helpers.cropSaveButton||(depth0!=null?depth0.cropSaveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropSaveButton","hash":{},"data":data}):helper)))+'</span></a>\n</div>\n<div class="changeOnServerEventListener"></div>';},"useData":true});this["JST"]["ui/presentation/components/image.toolkit/jst/gallery.template.hbs"]=Handlebars.template({"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var helper,alias1=depth0!=null?depth0:(container.nullContext||{}),alias2=helpers.helperMissing,alias3="function",alias4=container.escapeExpression;return'\n    <div class="galleryPrevArrow hideIfSingle"><button title="'+alias4(((helper=(helper=helpers.galleryArrowPrev||(depth0!=null?depth0.galleryArrowPrev:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"galleryArrowPrev","hash":{},"data":data}):helper)))+'"></button></div>\n    <div class="galleryNextArrow hideIfSingle"><button title="'+alias4(((helper=(helper=helpers.galleryArrowNext||(depth0!=null?depth0.galleryArrowNext:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"galleryArrowNext","hash":{},"data":data}):helper)))+'"></button></div>\n    <img id="imgPreviewPicture" class="changeImageSrc unselectable" src="'+alias4(((helper=(helper=helpers.imageSrc||(depth0!=null?depth0.imageSrc:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"imageSrc","hash":{},"data":data}):helper)))+'" alt="" />';},"useData":true});this["JST"]["ui/presentation/components/image.toolkit/jst/gallery.toolbar.template.hbs"]=Handlebars.template({"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var helper,alias1=depth0!=null?depth0:(container.nullContext||{}),alias2=helpers.helperMissing,alias3="function",alias4=container.escapeExpression;return'  <div class="toolbarButtonsContainer tGalleryBC">\n    <a class="markupButton hidden" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.markupButton||(depth0!=null?depth0.markupButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupButton","hash":{},"data":data}):helper)))+'"><b></b><span>'+alias4(((helper=(helper=helpers.markupButton||(depth0!=null?depth0.markupButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupButton","hash":{},"data":data}):helper)))+'</span></a>\n    <a class="rotateButton RotateImageFileUpload hidden" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.rotateButton||(depth0!=null?depth0.rotateButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"rotateButton","hash":{},"data":data}):helper)))+'"><b></b><span>'+alias4(((helper=(helper=helpers.rotateButton||(depth0!=null?depth0.rotateButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"rotateButton","hash":{},"data":data}):helper)))+'</span></a>\n    <a class="cropButton hidden" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.cropButton||(depth0!=null?depth0.cropButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropButton","hash":{},"data":data}):helper)))+'"><b></b><span>'+alias4(((helper=(helper=helpers.cropButton||(depth0!=null?depth0.cropButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropButton","hash":{},"data":data}):helper)))+'</span></a>\n    <div class="rightGalleryButtons">\n        <a class="downloadButton " href="'+alias4(((helper=(helper=helpers.imageSrc||(depth0!=null?depth0.imageSrc:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"imageSrc","hash":{},"data":data}):helper)))+'" title="'+alias4(((helper=(helper=helpers.downloadButton||(depth0!=null?depth0.downloadButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"downloadButton","hash":{},"data":data}):helper)))+'"><b></b><span>'+alias4(((helper=(helper=helpers.downloadButton||(depth0!=null?depth0.downloadButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"downloadButton","hash":{},"data":data}):helper)))+'</span></a>\n        <a class="deleteButton hidden" href="javascript:void(0);" title="'+alias4(((helper=(helper=helpers.deleteButton||(depth0!=null?depth0.deleteButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"deleteButton","hash":{},"data":data}):helper)))+'"><b></b><span>'+alias4(((helper=(helper=helpers.deleteButton||(depth0!=null?depth0.deleteButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"deleteButton","hash":{},"data":data}):helper)))+'</span></a>\n    </div>\n  </div>\n  <div class="imageInfo">\n    <span class="UplFileName answerBody" title="'+alias4(((helper=(helper=helpers.answerBody||(depth0!=null?depth0.answerBody:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerBody","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.answerExtension||(depth0!=null?depth0.answerExtension:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerExtension","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.fileSize||(depth0!=null?depth0.fileSize:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"fileSize","hash":{},"data":data}):helper)))+'">'+alias4(((helper=(helper=helpers.answerBody||(depth0!=null?depth0.answerBody:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerBody","hash":{},"data":data}):helper)))+'</span>\n    <span class="UplFileExtension answerExtension" title="'+alias4(((helper=(helper=helpers.answerBody||(depth0!=null?depth0.answerBody:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerBody","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.answerExtension||(depth0!=null?depth0.answerExtension:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerExtension","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.fileSize||(depth0!=null?depth0.fileSize:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"fileSize","hash":{},"data":data}):helper)))+'">'+alias4(((helper=(helper=helpers.answerExtension||(depth0!=null?depth0.answerExtension:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerExtension","hash":{},"data":data}):helper)))+'</span>\n    <span class="UplFileSize fileSize" title="'+alias4(((helper=(helper=helpers.answerBody||(depth0!=null?depth0.answerBody:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerBody","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.answerExtension||(depth0!=null?depth0.answerExtension:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerExtension","hash":{},"data":data}):helper)))+alias4(((helper=(helper=helpers.fileSize||(depth0!=null?depth0.fileSize:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"fileSize","hash":{},"data":data}):helper)))+'">'+alias4(((helper=(helper=helpers.fileSize||(depth0!=null?depth0.fileSize:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"fileSize","hash":{},"data":data}):helper)))+'</span>\n  </div>\n  <div class="rotateEventListener"></div>\n  <div class="deleteEventListener"></div>\n';},"useData":true});this["JST"]["ui/presentation/components/image.toolkit/jst/markup.toolbar.template.hbs"]=Handlebars.template({"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var helper,alias1=depth0!=null?depth0:(container.nullContext||{}),alias2=helpers.helperMissing,alias3="function",alias4=container.escapeExpression;return'<div class="imageInfoAction">\n    <span class="imgText">'+alias4(((helper=(helper=helpers.markupText||(depth0!=null?depth0.markupText:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupText","hash":{},"data":data}):helper)))+'</span>\n    <span class="imgHint">'+alias4(((helper=(helper=helpers.markupHint||(depth0!=null?depth0.markupHint:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupHint","hash":{},"data":data}):helper)))+'</span>\n</div>\n<div class="toolbarButtonsContainer">\n <div class="colorPanelDropdown">\n     <a class="pickColorButton red" href="javascript:void(0)" title="'+alias4(((helper=(helper=helpers.pickColor||(depth0!=null?depth0.pickColor:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"pickColor","hash":{},"data":data}):helper)))+'"><b></b></a>\n     <div class="colorPanel">\n         <ul>\n             <li class="color black" data-color="black"></li>\n             <li class="color white" data-color="white"></li>\n             <li class="color red"   data-color="red"></li>\n             <li class="color green" data-color="green"></li>\n             <li class="color blue" data-color="blue"></li>\n             <li class="arrowTop"><b></b></li>\n         </ul>\n     </div>\n </div>\n\n  <a class="gEditBTN clearButton hasImageDrawingListener disabled" title="'+alias4(((helper=(helper=helpers.markupClearButton||(depth0!=null?depth0.markupClearButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupClearButton","hash":{},"data":data}):helper)))+'" href="javascript:void(0);"><b></b></a>\n  <a class="gEditBTN cancelButton "  title="'+alias4(((helper=(helper=helpers.markupCancelButton||(depth0!=null?depth0.markupCancelButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupCancelButton","hash":{},"data":data}):helper)))+'" href="javascript:void(0);"><b></b><span>'+alias4(((helper=(helper=helpers.markupCancelButton||(depth0!=null?depth0.markupCancelButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupCancelButton","hash":{},"data":data}):helper)))+'</span></a>\n  <a class="gEditBTN saveButton disabled"  title="'+alias4(((helper=(helper=helpers.saveButton||(depth0!=null?depth0.saveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"saveButton","hash":{},"data":data}):helper)))+" "+alias4(((helper=(helper=helpers.markupSaveButton||(depth0!=null?depth0.markupSaveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupSaveButton","hash":{},"data":data}):helper)))+'" href="javascript:void(0);">'+alias4(((helper=(helper=helpers.saveButton||(depth0!=null?depth0.saveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"saveButton","hash":{},"data":data}):helper)))+" <span>"+alias4(((helper=(helper=helpers.markupSaveButton||(depth0!=null?depth0.markupSaveButton:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupSaveButton","hash":{},"data":data}):helper)))+'</span></a>\n</div>\n<div class="changeOnServerEventListener"></div>';},"useData":true});this["JST"]["ui/presentation/components/image.toolkit/jst/top.panel.template.hbs"]=Handlebars.template({"1":function(container,depth0,helpers,partials,data){var helper,alias1=depth0!=null?depth0:(container.nullContext||{}),alias2=helpers.helperMissing,alias3="function",alias4=container.escapeExpression;return'\n    <div class="topPanelQuestionText" >'+alias4(((helper=(helper=helpers.questionText||(depth0!=null?depth0.questionText:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"questionText","hash":{},"data":data}):helper)))+'</div>\n    <div class="topPanelNav">\n        <a class="galleryCloseButton" title="'+alias4(((helper=(helper=helpers.closeImageGalleryLabel||(depth0!=null?depth0.closeImageGalleryLabel:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"closeImageGalleryLabel","hash":{},"data":data}):helper)))+'"><span>'+alias4(((helper=(helper=helpers.closeImageGalleryLabel||(depth0!=null?depth0.closeImageGalleryLabel:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"closeImageGalleryLabel","hash":{},"data":data}):helper)))+'</span></a>\n        <div class="topPanelAnswerTitle">\n            '+alias4(((helper=(helper=helpers.answerTitle||(depth0!=null?depth0.answerTitle:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"answerTitle","hash":{},"data":data}):helper)))+'\n        </div>\n    </div>\n\n\n    <div class="oldAndroid imageInfoAction markap">\n        <span class="imgText">'+alias4(((helper=(helper=helpers.markupText||(depth0!=null?depth0.markupText:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupText","hash":{},"data":data}):helper)))+'</span>\n        <span class="imgHint">'+alias4(((helper=(helper=helpers.markupHint||(depth0!=null?depth0.markupHint:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"markupHint","hash":{},"data":data}):helper)))+'</span>\n    </div>\n    <div class="oldAndroid imageInfoAction crop">\n        <span class="imgText">'+alias4(((helper=(helper=helpers.cropText||(depth0!=null?depth0.cropText:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropText","hash":{},"data":data}):helper)))+'</span>\n        <span class="imgHint">'+alias4(((helper=(helper=helpers.cropHint||(depth0!=null?depth0.cropHint:depth0))!=null?helper:alias2),(typeof helper===alias3?helper.call(alias1,{"name":"cropHint","hash":{},"data":data}):helper)))+"</span>\n    </div>\n\n";},"compiler":[7,">= 4.0.0"],"main":function(container,depth0,helpers,partials,data){var stack1;return((stack1=(helpers.useBundle||(depth0&&depth0.useBundle)||helpers.helperMissing).call(depth0!=null?depth0:(container.nullContext||{}),"SurveyLook",{"name":"useBundle","hash":{},"fn":container.program(1,data,0),"inverse":container.noop,"data":data}))!=null?stack1:"");},"useData":true});(function($,_,Backbone){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Models||(appRoot.ImageToolkit.Models={});appRoot.ImageToolkit.Models.BaseImageModel=Backbone.BindedModel.extend({mainUtil:undefined,initOptions:undefined,currentImage:undefined,shift:undefined,fromGallery:false,realImageHeight:undefined,realImageWidth:undefined,initializeModel:function(arg){this.initOptions=arg;this.currentImage=arg.currentImage;this.shift=arg.shift;if(arg.fromGallery){this.fromGallery=arg.fromGallery;}},getInitOptions:function(){return this.initOptions;},getCurrentImage:function(){return this.currentImage;},getShift:function(){return this.shift;},setMainUtil:function(mainUtil){this.mainUtil=mainUtil;},getMainUtil:function(){return this.mainUtil;},save:function(){this.set("hasUnsavedData",false);},updateAfterServerChange:function(newHash,oldHash,fileSize){var src=this.get("currentImage").imageSrc;var currentImage=this.get("currentImage");if(newHash&&oldHash){currentImage.newHash=newHash;currentImage.oldHash=oldHash;currentImage.rotateUrl=window.FU_Utils.updateUrl(currentImage.rotateUrl,oldHash,newHash);currentImage.removeUrl=window.FU_Utils.updateUrl(currentImage.removeUrl,oldHash,newHash);currentImage.cropUrl=window.FU_Utils.updateUrl(currentImage.cropUrl,oldHash,newHash);currentImage.saveMarkupUrl=window.FU_Utils.updateUrl(currentImage.saveMarkupUrl,oldHash,newHash);currentImage.originalUrl=window.FU_Utils.updateUrl(currentImage.originalUrl,oldHash,newHash);src=window.FU_Utils.updateUrl(src,oldHash,newHash);}var fileSize=" ("+window.FU_Utils.convertSize(fileSize)+")";currentImage.fileSize=fileSize;this.set("fileSize",fileSize);currentImage.imageSrc=src;this.set("imageChangedOnServer",src);}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Models.BaseImageModel;}}).call(window,jQuery,_,Backbone);(function($,_,Backbone){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Models||(appRoot.ImageToolkit.Models={});appRoot.ImageToolkit.Models.CropModel=appRoot.ImageToolkit.Models.BaseImageModel.extend({initializeModel:function(arg){appRoot.ImageToolkit.Models.BaseImageModel.prototype.initializeModel.call(this,arg);},save:function(){this.set("hasUnsavedData",false);}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Models.CropModel;}}).call(window,jQuery,_,Backbone);(function($,_,Backbone){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Models||(appRoot.ImageToolkit.Models={});appRoot.ImageToolkit.Models.GalleryModel=appRoot.ImageToolkit.Models.BaseImageModel.extend({images:undefined,currentIndex:0,imageSrc:undefined,showRotateButton:false,showDeleteButton:false,showMarkupButton:false,showCropButton:false,oldHash:undefined,newHash:undefined,initializeModel:function(arg){appRoot.ImageToolkit.Models.BaseImageModel.prototype.initializeModel.call(this,arg);this.currentIndex=arg.currentIndex;this.images=arg.images;this.showRotateButton=arg.showRotateButton;this.showDeleteButton=arg.showDeleteButton;this.showMarkupButton=arg.showMarkupButton;this.showCropButton=arg.showCropButton;this._updateCurrentState(this.currentIndex);},next:function(){if(this.get("nextEnabled")){this._updateCurrentState(++this.currentIndex);}},prev:function(){if(this.get("prevEnabled")){this._updateCurrentState(--this.currentIndex);}},updateAfterDelete:function(){this.images.splice(this.currentIndex,1);this.set("deletedImage",this.get("currentImage"));if(!this.get("nextEnabled")){this.currentIndex--;}this._updateCurrentState(this.currentIndex);},_updateCurrentState:function(index){var imgCnt=this.images.length;this.set("close",imgCnt==0);this.set("isSingle",imgCnt==1);this.set("prevEnabled",index>0);this.set("nextEnabled",index<imgCnt-1);if(!this.get("close")&&index>=0&&index<imgCnt){this.set("currentImage",this.images[index]);}}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Models.GalleryModel;}}).call(window,jQuery,_,Backbone);(function($,_,Backbone){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Models||(appRoot.ImageToolkit.Models={});appRoot.ImageToolkit.Models.MarkupModel=appRoot.ImageToolkit.Models.BaseImageModel.extend({STROKE_WIDTH_COEFFICIENT:100,LINE_JOIN:"round",LINE_CAP:"square",points:{},paths:-1,initializeModel:function(arg){appRoot.ImageToolkit.Models.BaseImageModel.prototype.initializeModel.call(this,arg);if(this.get("currentImage").hasImageDrawing){this.set("hasImageDrawing",true);}},getCurrentImage:function(){var currentImage=this.get("currentImage");var newImage=jQuery.extend(true,{},currentImage);newImage.imageSrc=window.appRoot&&window.appRoot.isDevice()?currentImage.imageSrc:currentImage.originalUrl;return newImage;},save:function(){this.set("hasUnsavedData",false);},setCurrentColor:function(color){this.set("color",color);}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Models.MarkupModel;}}).call(window,jQuery,_,Backbone);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Util||(appRoot.ImageToolkit.Util={});var mainUtil=appRoot.ImageToolkit.Util.mainUtil={view:undefined,model:undefined,topPanelView:undefined,toolbarView:undefined,ImageComponent:{model:undefined,view:undefined,toolbarView:undefined,topPanelView:undefined},showBaseImage:function(options){this.ImageComponent={model:appRoot.ImageToolkit.Models.BaseImageModel,view:appRoot.ImageToolkit.Views.BaseImageView,topPanelView:appRoot.ImageToolkit.Views.TopPanelView};mainUtil._init(options);},showGallery:function(options){this.ImageComponent={model:appRoot.ImageToolkit.Models.GalleryModel,view:appRoot.ImageToolkit.Views.GalleryView,toolbarView:appRoot.ImageToolkit.Views.GalleryToolbarView,topPanelView:appRoot.ImageToolkit.Views.TopPanelView};mainUtil._init(options);},showMarkup:function(options){this.ImageComponent={model:appRoot.ImageToolkit.Models.MarkupModel,view:appRoot.ImageToolkit.Views.MarkupView,toolbarView:appRoot.ImageToolkit.Views.MarkupToolbarView,topPanelView:appRoot.ImageToolkit.Views.TopPanelView};mainUtil._init(options);},showCrop:function(options){this.ImageComponent={model:appRoot.ImageToolkit.Models.CropModel,view:appRoot.ImageToolkit.Views.CropView,toolbarView:appRoot.ImageToolkit.Views.CropToolbarView,topPanelView:appRoot.ImageToolkit.Views.TopPanelView};mainUtil._init(options);},removeMainView:function(){if(this.view){this.view.remove();}},_init:function(options){this._initModel(options);this._initViews(options);},_initModel:function(params){this.model=new this.ImageComponent.model(params);this.model.setMainUtil(mainUtil);},_initViews:function(params){var container=params.$imagePreviewParent;container.empty();this.topPanelView=this._initView(this.ImageComponent.topPanelView,container,params);this.view=this._initView(this.ImageComponent.view,container,params);this.toolbarView=this._initView(this.ImageComponent.toolbarView,container,params);},_initView:function(View,container,params){var view=undefined;if(View){view=new View({model:this.model,options:params,container:container}).render();view.$el.appendTo(container);}return view;},getView:function(){return this.view;},getModel:function(){return this.model;}};if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Util.mainUtil;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});var self=undefined;appRoot.ImageToolkit.Views.BaseImageView=Backbone.BindedView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/base.image.template.hbs"],tagName:"div",className:"imageDrawingContainer",container:undefined,SMALL_SCREEN_WIDTH:640,DEFAULT_TOP_PANEL_HEIGHT:100,SMALL_SCREEN_TOP_PANEL_HEIGHT:55,TOP_MARGIN:15,DEFAULT_TOOLBAR_HEIGHT:45,BOTTOM_MARGIN:20,LEFT_RIGHT_MARGINS:15*2,MIN_IMAGE_SIZE:25,DEBOUNCE_TIME:100,initializeView:function(arg){this.container=arg.container;self=this;$(window).resize(_.debounce(function(){self.changeWidthHeights();},self.DEBOUNCE_TIME));$(window).on("orientationchange.gallery",function(){self.changeWidthHeights();});},renderView:function(){var options=$.extend(this.model.getCurrentImage(),window.fileUploadTranslations);if(window.appRoot&&window.appRoot.isDevice()&&options.imageSrc){options.imageSrc=options.imageSrc+"?_rand="+Math.random();}this.$el.html(this.template(options));this.showInFullScreen();if(window.FU_Utils.isSafari()&&!this.model.fromGallery){history.pushState("gallery","");}},imageLoad:function(){var $img=$(this);$img.removeClass("hidden");self.model.set("disabled",false);self.changeWidthHeights($img);},changeWidthHeights:function($img){setTimeout(function(){self.container.loadingOn();if(!$img){$img=$("#imgPreviewPicture");}window.FU_Utils.alignImage($img);self.adjustContent($img);},100);if(!$($img).hasClass("activeEditViewMarkup")){setTimeout(function(){window.FU_Utils.canvasResizer($img);},150);}},adjustContent:function($img){if(self.model.get("disabled")){return;}self.container.loadingOff();},showInFullScreen:function(){this.model.set("disabled",true);this.container.loadingOn();window.scroll(0,0);$(document.body).addClass("unscrollable");$("#main_frame").addClass("unscrollable");$("#formBackCont").addClass("hidden");this.container.removeClass("hidden");var $img=this.$el.find("#imgPreviewPicture");$img.css("max-height",this.calculateMaxHeight()).css("max-width",this.calculateMaxWidth());$img.addClass("hidden");$img.load(this.imageLoad);this.container.on("dragstart",function(event){event.preventDefault();});this.container.on("selectstart",function(event){event.preventDefault();});},alignImage:function($img){if($img.length==0){return;}var img=$img.get(0);var imageWidth=img.naturalWidth;var imageHeight=img.naturalHeight;var imageRatio=imageHeight/imageWidth;var screenRatio=self.calculateMaxHeight()/self.calculateMaxWidth();var maxHeight=self.calculateMaxHeight();var maxWidth=(imageRatio<screenRatio?self.calculateMaxWidth():"");$img.css({"max-height":maxHeight,"max-width":maxWidth,"height":"","width":""});},calculateMaxHeight:function(){var topPanelHeight=window.innerWidth>self.SMALL_SCREEN_WIDTH?self.DEFAULT_TOP_PANEL_HEIGHT:self.SMALL_SCREEN_TOP_PANEL_HEIGHT;return Math.max(window.innerHeight-topPanelHeight-self.TOP_MARGIN-self.DEFAULT_TOOLBAR_HEIGHT-self.BOTTOM_MARGIN,self.MIN_IMAGE_SIZE);},calculateMaxWidth:function(){return Math.max(window.innerWidth-self.LEFT_RIGHT_MARGINS,self.MIN_IMAGE_SIZE);},convertCoordScreenToReal:function(coord,$img){if($img.length==0){return coord;}var img=$img.get(0);var realWidth=img.naturalWidth;var realHeight=img.naturalHeight;var onScreenImageWidth=$img.width();var onScreenImageHeight=$img.height();var realCoord=[];for(var i=0;i<coord.length/2;i++){realCoord.push(Math.round(coord[2*i]*realWidth/onScreenImageWidth));realCoord.push(Math.round(coord[2*i+1]*realHeight/onScreenImageHeight));}return realCoord;},convertCoordRealToScreen:function(coord,$img){if($img.length==0){return coord;}var img=$img.get(0);var realWidth=img.naturalWidth;var realHeight=img.naturalHeight;var onScreenImageWidth=$img.width();var onScreenImageHeight=$img.height();var screenCoord=[];for(var i=0;i<coord.length/2;i++){screenCoord.push(Math.round(coord[2*i]*onScreenImageWidth/realWidth));screenCoord.push(Math.round(coord[2*i+1]*onScreenImageHeight/realHeight));}return screenCoord;},isStringBase64Image:function(str){return str&&str.length>0&&str.indexOf("data:image")===0;},initCanvas:function($img,base64Image){var $imgParent=$img.parent();var $canvas=$imgParent.find("canvas");$canvas.remove();$canvas=$("<canvas />");$imgParent.append($canvas);var width=$img.get(0).width;var height=$img.get(0).height;$canvas.attr("width",width);$canvas.attr("height",height);if(this.isStringBase64Image(base64Image)){var context=$canvas.get(0).getContext("2d");var image=new Image();image.src=base64Image;image.onload=function(){context.drawImage(this,0,0,width,height);};}return $canvas;}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.BaseImageView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.BaseToolbarView=Backbone.BindedView.extend({renderView:function(){var options=$.extend(this.model.get("currentImage"),window.fileUploadTranslations);this.$el.html(this.template(options));this.$el.find("a.disabled").on("click","a.disabled",function(event){event.preventDefault();});},exit:function(){this.eventsOff();this.model.mainUtil.removeMainView();if(this.model.fromGallery){this.model.mainUtil.showGallery(this.model.getInitOptions());}else{this.model.set("close",true);}},updateAfterServerChange:function($el,val,model,options){if(val){var currentImage=model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $img=$("#fileUploadContainerImg_"+questionId+"_"+answerId);var src=$img.attr("src");if(src){var newHash=currentImage.newHash;var oldHash=currentImage.oldHash;if(newHash&&oldHash){$el.attr("href",window.FU_Utils.updateUrl(val,oldHash,newHash));$("#rotateUploadFile_"+questionId+"_"+answerId).data("hash",newHash);$("#deleteUploadFile_"+questionId+"_"+answerId).data("hash",newHash);var fileInputHidden=$("#inputtextother"+questionId+"_"+answerId);var downloadUploadFile=$("#downloadUploadFile_"+questionId+"_"+answerId);fileInputHidden.data("link",window.FU_Utils.updateUrl(fileInputHidden.data("link"),oldHash,newHash));downloadUploadFile.attr("href",window.FU_Utils.updateUrl(downloadUploadFile.attr("href"),oldHash,newHash));$img.attr("src",window.FU_Utils.updateUrl(src,oldHash,newHash));$img.data("fileurl",window.FU_Utils.updateUrl($img.data("fileurl"),oldHash,newHash));$img.data("originalurl",window.FU_Utils.updateUrl($img.data("originalurl"),oldHash,newHash));currentImage.oldHash=undefined;currentImage.newHash=undefined;}}$("#fileSizeUploadFile_"+questionId+"_"+answerId).html(currentImage.fileSize);var self=this;if(self.model.get("exit")){$img.one("load",function(){self.model.set("disabled",false);$("#imagePreviewParent").loadingOff();self.exit();});}}},eventsOff:function(){$(document).off("keyup");$(window).off("resize");$(window).off("orientationchange.gallery");},handleError:function(){$("#imagePreviewParent").loadingOff();this.model.set("disabled",false);}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.BaseToolbarView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.CropToolbarView=appRoot.ImageToolkit.Views.BaseToolbarView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/crop.toolbar.template.hbs"],className:"galleryToolbar activeEditBar cropToolbar",renderView:function(){var options=$.extend(this.model.get("currentImage"),window.fileUploadTranslations);this.$el.html(this.template(options));},customBindings:{".previewButton":{observe:"previewEnabled",update:function($el,val,model,options){if(val){$el.removeClass("disabled");}else{$el.addClass("disabled");}}},".saveButton, .undoButton":{observe:"preview",update:function($el,val,model,options){if(val){$el.removeClass("disabled");}else{$el.addClass("disabled");}}},".changeOnServerEventListener":{observe:"imageChangedOnServer",update:"updateAfterServerChange"}},events:{"click .cancelButton":"exitFromCrop","click .saveButton":"save","click .previewButton":"preview","click .undoButton":"undo"},exitFromCrop:function(){if(this.model.get("hasUnsavedData")){if(confirm(window.fileUploadTranslations.closeGalleryConfirm)){this.exit();}}else{this.exit();}},save:function(event){event.preventDefault();if(this.model.get("disabled")){return;}if($(event.target).closest(".disabled").length>0){return;}if(this.model.get("hasUnsavedData")){$("#imagePreviewParent").loadingOn();this.model.set("disabled",true);this.model.set("preview",false);var self=this;var coords=this.model.get("cropCoords");var currentImage=this.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var imageDrawing=$("#fileUploadContainerImg_"+questionId+"_"+answerId).attr("data-imagedrawing");if(imageDrawing){var img=new Image();img.src=imageDrawing;img.onload=function(){var theImg=this;setTimeout(function(){self.cropImageWithDrawing(theImg,coords);},100);};img=null;}else{this.sendCrop(coords,null);}}},cropImageWithDrawing:function(img,coords){var realWidth=this.model.get("naturalImageWidth");var realHeight=this.model.get("naturalImageHeight");var imageDrawingSize=window.FU_Utils.limitImageDrawingSize(img.width,img.height);var width=imageDrawingSize.width;var height=imageDrawingSize.height;var w=Math.round(coords.w*width/realWidth);var h=Math.round(coords.h*height/realHeight);var x=Math.round(coords.x*width/realWidth);var y=Math.round(coords.y*height/realHeight);var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;var ctx=canvas.getContext("2d");ctx.drawImage(img,x,y,w,h,0,0,w,h);var imageDrawing=canvas.toDataURL();this.sendCrop(coords,imageDrawing);},sendCrop:function(coords,imageDrawing){if(window.appRoot&&window.appRoot.isDevice()){this.sendCropNative(coords,imageDrawing);}else{this.sendCropAjax(coords,imageDrawing);}},sendCropAjax:function(coords,imageDrawing){var cropUrl=this.model.get("currentImage").cropUrl;var index=cropUrl.indexOf("?dummy=");cropUrl=index!=-1?cropUrl.substring(0,index):cropUrl;cropUrl=cropUrl+"/"+coords.x+"/"+coords.y+"/"+coords.w+"/"+coords.h+"?dummy="+new Date().getTime();var self=this;$.ajax({url:cropUrl,type:"POST",dataType:"json",data:{imageDrawing:imageDrawing},success:function(data){if(data.error===false){if(imageDrawing){var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;$("#fileUploadContainerImg_"+questionId+"_"+answerId).attr("data-imagedrawing",imageDrawing);}self.model.set("exit",true);self.model.updateAfterServerChange(data.newHash,data.oldHash,data.fileSize);self.model.save();}else{self.handleError();}},error:function(xhr,ajaxOptions,thrownError){self.handleError();}});},sendCropNative:function(coords,imageDrawing){var self=this;if(window.appRoot.getMajorVersion()<11){return;}var currentImage=this.model.get("currentImage");var realWidth=this.model.get("naturalImageWidth");var realHeight=this.model.get("naturalImageHeight");var x=coords.x/realWidth;var y=coords.y/realHeight;var w=coords.w/realWidth;var h=coords.h/realHeight;var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $img=$("#fileUploadContainerImg_"+questionId+"_"+answerId);var imagePath=$img.data("fileurl");window.appRoot.fs.cropImage(imagePath,imagePath,x,y,w,h).done(function(){window.appRoot.fs.getFileByUrl(imagePath).done(function(fileObj,imagePath){window.FU_Utils.updateAttachedImage(questionId,answerId,imagePath,imageDrawing,fileObj.size).done(function(){var fileSize=" ("+window.FU_Utils.convertSize(fileObj.size)+")";$("#fileSizeUploadFile_"+questionId+"_"+answerId).text(fileSize);currentImage.fileSize=fileSize;self.model.set("fileSize",fileSize);self.model.set("disabled",false);self.model.set("hasUnsavedData",false);$("#imagePreviewParent").loadingOff();self.exit();});});}).fail(function(error){self.handleError();if(error){alert(error);}self.exit();});},preview:function(event){event.preventDefault();if($(event.target).hasClass("disabled")){return;}this.model.set("preview",true);},undo:function(event){if($(event.target).hasClass("disabled")){return;}this.model.set("preview",false);this.model.set("undo",true);}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.CropToolbarView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});var self=undefined;appRoot.ImageToolkit.Views.CropView=appRoot.ImageToolkit.Views.BaseImageView.extend({jcrop_api:undefined,jcropInitStarted:false,initializeView:function(arg){appRoot.ImageToolkit.Views.BaseImageView.prototype.initializeView.call(this,arg);self=this;},renderView:function(){appRoot.ImageToolkit.Views.BaseImageView.prototype.renderView.call(this);this.container.removeClass("activeEditViewMarkup");this.container.addClass("activeEditView  activeEditViewCrop");},remove:function(){if(self.jcrop_api){self.jcrop_api.destroy();self.jcrop_api=undefined;}appRoot.ImageToolkit.Views.BaseImageView.prototype.remove.call(this);},initJCrop:function($img){if(self.model.get("preview")){self.container.loadingOff();return;}self.jcropInitStarted=true;var initialSelection=undefined;if(self.model.get("cropCoords")){var c=self.model.get("cropCoords");var screenCoords=self.convertCoordRealToScreen([c.x,c.y,c.x+c.w,c.y+c.h],$img);initialSelection=[screenCoords[0],screenCoords[1],screenCoords[2],screenCoords[3]];}$img.Jcrop({bgColor:"",onSelect:function(coords){self.selectArea(coords,$img);},onChange:function(coords){self.selectArea(coords,$img);},keySupport:false,maxSize:[$img.css("width"),$img.css("height")],setSelect:initialSelection},function(){self.jcrop_api=this;self.jcropInitStarted=false;self.container.loadingOff();});$(".jcrop-holder").addClass("unselectable");self.model.set("undo",false);},selectArea:function(coords,$img){var selected=coords.w>0&&coords.h>0;self.model.set("hasUnsavedData",selected);self.model.set("previewEnabled",selected);var realCoords=self.convertCoordScreenToReal([coords.x,coords.y,coords.w,coords.h],$img);var trueCoords={x:realCoords[0],y:realCoords[1],w:realCoords[2],h:realCoords[3]};self.model.set("cropCoords",trueCoords);},adjustContent:function($img){if($img.length==0||!$img.get(0).complete){return;}if(self.model.get("disabled")){return;}if(self.jcrop_api){self.jcrop_api.destroy();self.jcropInitStarted=false;}if(!self.jcropInitStarted){self.initJCrop($img);}},customBindings:{".changeImageSrc":{observe:"preview",update:function($img,val,model,options){if(val&&self.jcrop_api&&model.get("hasUnsavedData")){self.model.set("previewEnabled",false);self.jcrop_api.destroy();self.jcrop_api=undefined;self.model.set("naturalImageWidth",$img.get(0).naturalWidth);self.model.set("naturalImageHeight",$img.get(0).naturalHeight);$img.css({"height":"","width":""});var c=self.model.get("cropCoords");var croppedRatio=c.w/c.h;var screenRatio=self.calculateMaxHeight()/self.calculateMaxWidth();var h,w;if(croppedRatio<screenRatio){h=Math.min(c.h,self.calculateMaxHeight());w=Math.round(h*c.w/c.h);}else{w=Math.min(c.w,self.calculateMaxWidth());h=Math.round(w*c.h/c.w);}var canvas=document.createElement("canvas");canvas.width=w;canvas.height=h;var ctx=canvas.getContext("2d");var img=$img.get(0);ctx.drawImage(img,c.x,c.y,c.w,c.h,0,0,w,h);var base64ImageData=canvas.toDataURL();$img.attr("src",base64ImageData);}}},"#imgPreviewPicture":{observe:"undo",update:function($img,val,model,options){if(val){$img.attr("src",self.model.get("currentImage").imageSrc);self.model.set("cropCoords",undefined);this.model.set("hasUnsavedData",false);}}}}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.CropView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.GalleryToolbarView=appRoot.ImageToolkit.Views.BaseToolbarView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/gallery.toolbar.template.hbs"],tagName:"div",className:"galleryToolbar",renderView:function(){var options=$.extend(this.model.get("currentImage"),window.fileUploadTranslations);this.$el.html(this.template(options));},customBindings:{".answerBody":{observe:"currentImage",update:function($el,val,model,options){$el.text(val.answerBody);this.updateTitle($el,val);}},".answerExtension":{observe:"currentImage",update:function($el,val,model,options){$el.text(val.answerExtension);this.updateTitle($el,val);}},".fileSize":{observe:"currentImage",update:function($el,val,model,options){val.fileSize=val.fileSize.replace(" ","");$el.text(val.fileSize);this.updateTitle($el,val);}},".UplFileSize":{observe:"fileSize",update:function($el,val,model,options){if(val){$el.text(val);this.updateTitle($el,model.get("currentImage"));}}},".downloadButton":{observe:"currentImage",update:function($el,val,model,options){$el.attr("href",val.imageSrc);}},".rotateButton":{observe:"showRotateButton",update:function($el,val,model,options){if(val&&!(window.appRoot&&window.appRoot.isDevice()&&window.appRoot.getMajorVersion()<11)){$el.removeClass("hidden");}}},".deleteButton":{observe:"showDeleteButton",update:function($el,val,model,options){if(val){$el.removeClass("hidden");}}},".markupButton":{observe:"showMarkupButton",update:function($el,val,model,options){if(val){$el.removeClass("hidden");}}},".cropButton":{observe:"showCropButton",update:function($el,val,model,options){if(val&&!(window.appRoot&&window.appRoot.isDevice()&&window.appRoot.getMajorVersion()<11)){$el.removeClass("hidden");}}},".rotateEventListener, .downloadButton":{observe:"imageChangedOnServer",update:"updateAfterServerChange"},".deleteEventListener":{observe:"deletedImage",update:function($el,val,model,options){if(val){var q_a=val.questionId+"_"+val.answerId;$("#inputtextother"+q_a).val("");$("#FUIFileInputBox_"+q_a).removeClass("hidden");$("#fileInput_"+q_a).removeClass("hidden");$("#FUIFooter_"+q_a).addClass("hidden");$("#fileUploadContainer_"+q_a).addClass("hidden");$("#fileUploadContainerImg_"+q_a).attr("src","");}}}},events:{"click .rotateButton":"rotateImage","click .deleteButton":"deleteImage","click .markupButton":"switchToMarkup","click .cropButton":"switchToCrop","click .downloadButton":"downloadImage"},rotateImage:function(){if(this.model.get("disabled")){return;}var self=this;var isAllowed=function(){if(window.appRoot&&window.appRoot.isDevice()){var currentImage=self.model.get("currentImage");return FU_Utils.isEditAllowed(currentImage.originalUrl).then(function(isAllow){return isAllow?window.appRoot.resolved():window.appRoot.rejected();});}else{var dfd=$.Deferred();dfd.resolve();return dfd;}};isAllowed().done(function(){self.model.set("disabled",true);$("#imagePreviewParent").loadingOn();$(".rotateButton").blur();var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var imageDrawing=$("#fileUploadContainerImg_"+questionId+"_"+answerId).attr("data-imagedrawing");if(imageDrawing){var img=new Image();img.src=imageDrawing;img.onload=function(){var theImg=this;setTimeout(function(){self.rotateImageWithDrawing(theImg);},100);};img=null;}else{self.sendRotate(null);}});},sendRotate:function(imageDrawing){if(window.appRoot&&window.appRoot.isDevice()){var currentImage=this.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var self=this;window.FU_Utils.deviceRotate(questionId,answerId,null,null,imageDrawing).done(function(imagePath,drawing){var $el=jQuery("#imgPreviewPicture");var maxWidth=FU_Utils.getPreviewImageWidth();window.appRoot.fs.resizeAttachedImage(imagePath,imageDrawing,true,FU_Utils.getTmpFileName(questionId,answerId),maxWidth,maxWidth).done(function(resultImagePath){$el.attr("src",resultImagePath+"?"+Math.random());});});}else{this.sendRotateAjax(imageDrawing);}},rotateImageWithDrawing:function(img){var imageDrawingSize=window.FU_Utils.limitImageDrawingSize(img.width,img.height);var canvas=document.createElement("canvas");var width=imageDrawingSize.width;var height=imageDrawingSize.height;canvas.width=height;canvas.height=width;var ctx=canvas.getContext("2d");ctx.translate(canvas.width/2,canvas.height/2);ctx.rotate(Math.PI/-2);ctx.drawImage(img,0,0,img.width,img.height,-canvas.height/2,-canvas.width/2,canvas.height,canvas.width);ctx.rotate(Math.PI/2);ctx.translate(-canvas.width/2,-canvas.height/2);var imageDrawing=canvas.toDataURL();this.sendRotate(imageDrawing);},sendRotateAjax:function(imageDrawing){var self=this;$.ajax({url:this.model.get("currentImage").rotateUrl,type:"POST",dataType:"json",data:{imageDrawing:imageDrawing},success:function(data){if(data.error===false){self.model.updateAfterServerChange(data.newHash,data.oldHash,data.fileSize);if(imageDrawing){var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;$("#fileUploadContainerImg_"+questionId+"_"+answerId).attr("data-imagedrawing",imageDrawing);}}else{self.handleError();}},error:function(xhr,ajaxOptions,thrownError){self.handleError();}});},deleteImage:function(){if(this.model.get("disabled")){return;}var self=this;if(window.appRoot&&window.appRoot.isDevice()){var currentImage=self.model.get("currentImage");return window.fileUploadHelper.deleteAttachedImage(currentImage.questionId,currentImage.answerId,currentImage.removeUrl,false).then(function(data){if(data.success===true){self.model.updateAfterDelete();}});}if(confirm(window.fileUploadTranslations.confirmDeleteFileLabel)){$.ajax({url:this.model.get("currentImage").removeUrl,type:"POST",dataType:"json",success:function(data){if(data.success===true){self.model.updateAfterDelete();}}});}},switchToMarkup:function(){this.eventsOff();var options=this.prepareOptionsToSwitch();if(window.appRoot&&window.appRoot.isDevice()){var self=this;FU_Utils.isEditAllowed(options.currentImage.originalUrl).done(function(isAllow){if(isAllow){if(window.appRoot.getMajorVersion()>=11){var maxWidth=FU_Utils.getPreviewImageWidth();window.appRoot.fs.resizeAttachedImage(options.currentImage.originalUrl,null,true,FU_Utils.getTmpFileName(options.currentImage.questionId,options.currentImage.answerId),maxWidth,maxWidth).done(function(resultImagePath){options.currentImage.imageSrc=resultImagePath;self.model.getMainUtil().showMarkup(options);});}else{self.model.getMainUtil().showMarkup(options);}}});}else{this.model.getMainUtil().showMarkup(options);}},updateTitle:function($el,val){$el.attr("title",val.answerBody+val.answerExtension+val.fileSize);},switchToCrop:function(){this.eventsOff();if(window.appRoot&&window.appRoot.isDevice()&&window.appRoot.getMajorVersion()>=11){var self=this;var options=this.prepareOptionsToSwitch();FU_Utils.isEditAllowed(options.currentImage.originalUrl).done(function(isAllow){if(!isAllow){return;}var $img=$("#fileUploadContainerImg_"+options.currentImage.questionId+"_"+options.currentImage.answerId);var imageDrawing=$img.attr("data-imagedrawing");var maxWidth=FU_Utils.getPreviewImageWidth();window.appRoot.fs.resizeAttachedImage(options.currentImage.originalUrl,imageDrawing,true,FU_Utils.getTmpFileName(options.currentImage.questionId,options.currentImage.answerId),maxWidth,maxWidth).done(function(resultImagePath){options.currentImage.imageSrc=resultImagePath;self.model.getMainUtil().showCrop(options);});});return;}this.model.getMainUtil().showCrop(this.prepareOptionsToSwitch());},prepareOptionsToSwitch:function(){var options=this.model.getInitOptions();options.currentImage=this.model.get("currentImage");options.currentIndex=this.model.currentIndex;options.fromGallery=true;return options;},downloadImage:function(){$(".downloadButton").blur();if(window.appRoot&&window.appRoot.isDevice()){var currentImage=this.model.get("currentImage");var $img=$("#fileUploadContainerImg_"+currentImage.questionId+"_"+currentImage.answerId);var imageDrawing=$img.attr("data-imagedrawing");window.fileUploadHelper.downloadAttachedFile(currentImage.originalUrl,imageDrawing,currentImage.questionId,currentImage.answerId);return false;}}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.GalleryToolbarView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.GalleryView=appRoot.ImageToolkit.Views.BaseImageView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/gallery.template.hbs"],touchPosition:null,isDevice:window.appRoot&&window.appRoot.isDevice(),initializeView:function(arg){var self=this;appRoot.ImageToolkit.Views.BaseImageView.prototype.initializeView.call(this,arg);$(document).on("keyup",function(evt){if(evt.keyCode==37){self.prev();}else{if(evt.keyCode==39){self.next();}}});},getSrc:function(url){return this.isDevice?url+(url.indexOf("?")>=0?"&":"?")+"__rand="+Math.random():url;},renderView:function(){appRoot.ImageToolkit.Views.BaseImageView.prototype.renderView.call(this);this.container.removeClass("activeEditView ");this.container.removeClass("activeEditViewCrop");this.container.removeClass("activeEditViewMarkup");},customBindings:{"#imgPreviewPicture":{observe:"currentImage",update:function($el,val,model,options){var questionId=val.questionId;var answerId=val.answerId;var $img=$("#fileUploadContainerImg_"+questionId+"_"+answerId);var imageDrawing=$img.attr("data-imagedrawing");if(!this.isDevice){$el.attr("src",this.isDevice?this.getSrc(val.imageSrc):val.imageSrc);}else{if(window.appRoot.getMajorVersion()>=11){var self=this;var modified=$img.attr("modified");var refreshIt=modified||$img.data("imagedrawingchanged")==1;var maxWidth=FU_Utils.getPreviewImageWidth();window.appRoot.fs.resizeAttachedImage(model.get("currentImage").originalUrl,imageDrawing,refreshIt,FU_Utils.getTmpFileName(questionId,answerId),maxWidth,maxWidth).done(function(resultImagePath){$el.attr("src",self.getSrc(resultImagePath));$el.load(function(){$el.off("load.drawing");});});}else{$el.off("load.drawing");$el.parent().find("canvas").remove();$el.on("load.drawing",function(){window.ImageToolkit.Views.BaseImageView.prototype.initCanvas($el,imageDrawing);});}}}},".changeImageSrc":{observe:"imageChangedOnServer",update:function($el,val,model,options){if(this.isDevice&&window.appRoot.getMajorVersion()>=11){return;}$el.attr("src",this.getSrc(model.get("currentImage").imageSrc));}},".galleryPrevArrow button":{observe:"prevEnabled",update:function($el,val,model,options){$el.prop("disabled",!val);}},".galleryNextArrow button":{observe:"nextEnabled",update:function($el,val,model,options){$el.prop("disabled",!val);}},".hideIfSingle":{observe:"isSingle",update:function($el,val,model,options){if(val){$el.addClass("hidden");}}}},events:{"click .galleryPrevArrow":"clickPrevArrow","click .galleryNextArrow":"clickNextArrow","touchstart":"startSwipe","touchmove":"swipe","touchend":"endSwipe"},clickPrevArrow:function(event){this.prev();},clickNextArrow:function(event){this.next();},prev:function(){if(this.model.get("disabled")){return;}if(this.model.get("prevEnabled")){this.container.loadingOn();this.model.set("disabled",true);this.model.prev();}},next:function(){if(this.model.get("disabled")){return;}if(this.model.get("nextEnabled")){this.container.loadingOn();this.model.set("disabled",true);this.model.next();}},startSwipe:function(event){try{if(event.originalEvent.touches[0].clientX&&this.touchPosition==null){this.touchPosition=event.originalEvent.touches[0].clientX;}}catch(e){this.touchPosition=null;}},swipe:function(event){try{if(event.originalEvent.touches[0].clientX&&this.touchPosition!=null){if(event.originalEvent.touches[0].clientX>(this.touchPosition+50)){this.touchPosition=null;this.prev();}else{if(event.originalEvent.touches[0].clientX<(this.touchPosition-50)){this.touchPosition=null;this.next();}}}}catch(e){this.touchPosition=null;}},endSwipe:function(event){this.touchPosition=null;}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.GalleryView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.MarkupToolbarView=appRoot.ImageToolkit.Views.BaseToolbarView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/markup.toolbar.template.hbs"],className:"galleryToolbar  activeEditBar markupToolbar",renderView:function(){var options=$.extend(this.model.get("currentImage"),window.fileUploadTranslations);this.$el.html(this.template(options));},customBindings:{".saveButton":{observe:"hasUnsavedData",update:function($el,val,model,options){if(val){$el.removeClass("disabled");}else{$el.addClass("disabled");}}},".clearButton":{observe:"hasDrawing",update:function($el,val,model,options){if(val){$el.removeClass("disabled");}else{$el.addClass("disabled");}}},".hasImageDrawingListener":{observe:"hasImageDrawing",update:function($el,val,model,options){if(val){$el.removeClass("disabled");}else{$el.addClass("disabled");}}},".changeOnServerEventListener":{observe:"imageChangedOnServer",update:"updateAfterServerChange"},".colorPanel":{observe:"hideColorPicker",update:function($el,val,model,options){if(val){this.hideColorPicker();model.set("hideColorPicker",false);}}}},events:{"click .cancelButton":"exit","click .saveButton":"save","click .clearButton":"clear","click .pickColorButton":"openColorPicker","click .colorPanel .color":"chooseColor","click .arrowTop":"hideColorPicker"},save:function(event){event.preventDefault();if(this.model.get("disabled")){return;}if($(event.target).hasClass("disabled")){return;}if(this.model.get("hasUnsavedData")){$("#imagePreviewParent").loadingOn();this.model.set("disabled",true);var $img=$("#imgPreviewPicture");if($img.length==0){return;}var img=$img.get(0);var canvas=document.createElement("canvas");var imageDrawingSize=window.FU_Utils.limitImageDrawingSize(img.naturalWidth,img.naturalHeight);canvas.width=imageDrawingSize.width;canvas.height=imageDrawingSize.height;var currentImage=this.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $votingImg=$("#fileUploadContainerImg_"+questionId+"_"+answerId);var imageDrawing=$votingImg.attr("data-imagedrawing");if(imageDrawing&&!this.model.get("imageDrawingCleared")){var self=this;var img=new Image();img.src=imageDrawing;img.onload=function(){var theImg=this;function msieversion(){var ua=window.navigator.userAgent;var msie=ua.indexOf("MSIE ");if(msie>0){return 100;}else{return false;}}var time_out=msieversion()||100;setTimeout(function(){var ctx=canvas.getContext("2d");ctx.drawImage(theImg,0,0,theImg.width,theImg.height,0,0,canvas.width,canvas.height);self.drawCurrentPaths(canvas,$img);self.sendSaveAjax(canvas);},time_out);};img=null;}else{this.drawCurrentPaths(canvas,$img);this.sendSaveAjax(canvas);}var ResizeCanvasSave=function(img,canvas){var box=$(img).parent();var canvas_s=$(box).find("canvas").get(0);if(canvas_s!=undefined){$(canvas_s).css({"max-width":$(img).width()+"px","max-height":$(img).height()+"px","width":$(img).width()+"px","height":$(img).height()+"px"});}if(window.appRoot&&window.appRoot.isDevice()&&window.appRoot.getMajorVersion()<11){setTimeout(function(){$votingImg=$("#fileUploadContainerImg_"+questionId+"_"+answerId);imageDrawing=$votingImg.attr("data-imagedrawing");window.ImageToolkit.Views.BaseImageView.prototype.initCanvas($votingImg,imageDrawing);},100);}};setTimeout(function(){ResizeCanvasSave($votingImg,canvas);},300);$(window).on("orientationchange",function(){setTimeout(function(){ResizeCanvasSave($votingImg,canvas);},150);});$(window).on("resize",function(){setTimeout(function(){ResizeCanvasSave($votingImg,canvas);},150);},false);}},drawCurrentPaths:function(canvas,$img){var paths=this.model.paths;var points=this.model.points;if(paths>=0){var context=canvas.getContext("2d");var minDimension=Math.min(canvas.width,canvas.height);context.lineWidth=Math.round(Math.max(minDimension/this.model.STROKE_WIDTH_COEFFICIENT,1));context.lineJoin=this.model.LINE_JOIN;context.lineCap=this.model.LINE_CAP;var img=$img.get(0);var realWidth=img.naturalWidth;var realHeight=img.naturalHeight;for(var path=0;path<=paths;path++){context.fillStyle=points[path].color;context.strokeStyle=points[path].color;var coord=[Math.round(points[path][0][0]*canvas.width/realWidth),Math.round(points[path][0][1]*canvas.height/realHeight)];context.beginPath();context.moveTo(coord[0],coord[1]);for(var i=1;i<points[path].length;i++){coord=[Math.round(points[path][i][0]*canvas.width/realWidth),Math.round(points[path][i][1]*canvas.height/realHeight)];context.lineTo(coord[0],coord[1]);}context.stroke();context.closePath();}}},sendSaveAjax:function(canvas){var imageDrawing=this.model.get("hasDrawing")?canvas.toDataURL():null;var self=this;if(window.appRoot&&window.appRoot.isDevice()){window.formChanges=true;self.model.set("exit",true);self.model.save();var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $votingImg=$("#fileUploadContainerImg_"+questionId+"_"+answerId);if(window.appRoot.getMajorVersion()>=11){if(imageDrawing){$votingImg.attr("data-imagedrawing",imageDrawing);currentImage.hasImageDrawing=true;}else{$votingImg.removeAttr("data-imagedrawing");currentImage.hasImageDrawing=false;}$votingImg.parent().loadingOn();var thimbnileSize=300*window.devicePixelRatio;window.appRoot.fs.resizeAttachedImage(currentImage.originalUrl,imageDrawing,true,FU_Utils.getTmpFileName(questionId,answerId),thimbnileSize,thimbnileSize).done(function(resultImagePath){$votingImg.attr("src",resultImagePath+"?_rand="+Math.random());$votingImg.load(function(){$votingImg.parent().loadingOff();});}).fail(function(){$votingImg.parent().loadingOff();});}else{if(imageDrawing){$votingImg.attr("data-imagedrawing",imageDrawing);window.ImageToolkit.Views.BaseImageView.prototype.initCanvas($votingImg,imageDrawing);currentImage.hasImageDrawing=true;}else{$votingImg.removeAttr("data-imagedrawing");window.appRoot.drawing.clearAttachedCanvas($votingImg);currentImage.hasImageDrawing=false;}}$votingImg.data("imagedrawingchanged",1);self.exit();return;}var saveMarkupUrl=this.model.get("currentImage").saveMarkupUrl;$.ajax({url:saveMarkupUrl,type:"POST",data:{imageDrawing:imageDrawing},dataType:"json",success:function(data){if(data.error===false){self.model.set("exit",true);self.model.updateAfterServerChange(data.newHash,data.oldHash,data.fileSize);self.model.save();var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $votingImg=$("#fileUploadContainerImg_"+questionId+"_"+answerId);if(imageDrawing){$votingImg.attr("data-imagedrawing",imageDrawing);currentImage.hasImageDrawing=true;}else{$votingImg.removeAttr("data-imagedrawing");currentImage.hasImageDrawing=false;}}else{self.handleError();}},error:function(xhr,ajaxOptions,thrownError){self.handleError();}});},clear:function(event){event.preventDefault();if($(event.target).hasClass("disabled")){return;}this.model.set("clear",true);},openColorPicker:function(event){event.preventDefault();if($(event.target).hasClass("disabled")){return;}$(".colorPanel").addClass("slideDown");},chooseColor:function(event){var color=$(event.target).data("color");this.model.setCurrentColor(color);this.$el.find(".pickColorButton").removeClass("black white red green blue").addClass(color);this.hideColorPicker();},hideColorPicker:function(){$(".colorPanel").removeClass("slideDown");}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.MarkupToolbarView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});var self=undefined;appRoot.ImageToolkit.Views.MarkupView=appRoot.ImageToolkit.Views.BaseImageView.extend({colorsMap:{black:"#000000",white:"#FFFFFF",red:"#FF0000",green:"#09b90E",blue:"#0000fb"},strokeColor:"#FF0000",paint:false,mouseDown:false,canvasOffsetX:0,canvasOffsetY:100,drawBase64Started:false,initializeView:function(arg){appRoot.ImageToolkit.Views.BaseImageView.prototype.initializeView.call(this,arg);self=this;},renderView:function(){appRoot.ImageToolkit.Views.BaseImageView.prototype.renderView.call(this);this.container.removeClass("activeEditViewCrop");this.container.addClass("activeEditView activeEditViewMarkup");var $img=this.$el.find("#imgPreviewPicture");$img.load(this.initCanvasDrawing);},isAndroidLessThanVersion443:function(){return window.device!=undefined&&window.device.platform=="Android"&&/^([1-3]|(4.[0-3])|(4.4.[0-3]))/i.test(window.device.version);},customBindings:{"#imgPreviewPicture":{observe:"clear",update:function($img,val,model,options){if(val){var $canvas=self.getAttachedCanvas($img);var c=$canvas.get(0);var context=c.getContext("2d");context.clearRect(0,0,c.width,c.height);if(this.isAndroidLessThanVersion443()){c.style.display="none";c.offsetHeight;c.style.display="inherit";}self.model.points={};self.model.paths=-1;model.set("hasUnsavedData",model.get("currentImage").hasImageDrawing);model.set("clear",false);model.set("hasDrawing",false);model.set("imageDrawingCleared",true);}}},"img":{observe:"color",update:function($el,val,model,options){if(val){this.strokeColor=this.colorsMap[val];}}}},markupStarted:function(){self.model.set("hasUnsavedData",true);self.model.set("hasDrawing",true);self.model.set("hideColorPicker",true);},getAttachedCanvas:function($img){var $imgBlock=$img.parent();return $imgBlock.find("canvas");},initImageCanvas:function($img){var $canvas=self.getAttachedCanvas($img);if($canvas.length===0){$canvas=$("<canvas />");$canvas.addClass("markupCanvas");$canvas.addClass("unselectable");$canvas.addClass("hidden");$img.parent().append($canvas);}return $canvas;},adjustContent:function($img){self.container.loadingOn();if($img.length==0||!$img.get(0).complete){return;}if(self.model.get("disabled")){return;}var $canvas=self.initImageCanvas($img);$canvas.addClass("hidden");$canvas.attr("width",$img.width());$canvas.attr("height",$img.height());if(!self.drawBase64Started){self.drawBase64Image($canvas,$img);}},drawBase64Image:function($canvas,$img){self.drawBase64Started=true;var currentImage=self.model.get("currentImage");var questionId=currentImage.questionId;var answerId=currentImage.answerId;var $votingImg=$("#fileUploadContainerImg_"+questionId+"_"+answerId);var base64Image=$votingImg.attr("data-imagedrawing");if(self.isStringBase64Image(base64Image)&&!self.model.get("imageDrawingCleared")){var width=$img.width();var height=$img.height();var context=$canvas.get(0).getContext("2d");var drawingImage=new Image();drawingImage.src=base64Image;drawingImage.onload=function(){var theImage=this;setTimeout(function(){context.drawImage(theImage,0,0,theImage.width,theImage.height,0,0,width,height);self.drawCurrentPaths($canvas,$img);},100);};}else{self.drawCurrentPaths($canvas,$img);}},drawCurrentPaths:function($canvas,$img){var context=$canvas.get(0).getContext("2d");self.setContextStyles(context);var paths=self.model.paths;var points=self.model.points;if(paths>=0){for(var path=0;path<=paths;path++){context.fillStyle=self.strokeColor;context.strokeStyle=points[path].color;var coord=self.convertCoordRealToScreen(points[path][0],$img);context.beginPath();context.moveTo(coord[0],coord[1]);for(var i=1;i<points[path].length;i++){coord=self.convertCoordRealToScreen(points[path][i],$img);context.lineTo(coord[0],coord[1]);}context.stroke();context.closePath();}}if(!self.model.get("disabled")){$canvas.removeClass("hidden");this.container.loadingOff();}self.drawBase64Started=false;},initCanvasDrawing:function(){var $img=$(this);var $canvas=self.initImageCanvas($img);var canvas=$canvas.get(0);if(self.isSupportTouch()){self.initForMobile(canvas,$img);}else{self.initForDesktop(canvas,$img);}return $canvas;},isSupportTouch:function(){return"ontouchstart" in window||navigator.msMaxTouchPoints;},endPaint:function(){self.paint=false;},isStringBase64Image:function(str){return str&&str.length>0&&str.indexOf("data:image")===0;},drawStart:function(e,context,getCoordFunc,$img){e.preventDefault();self.paint=true;self.setContextStyles(context);var coord=getCoordFunc(e);var paths=++self.model.paths;var points=self.model.points;points[paths]=[];context.beginPath();context.moveTo(coord[0],coord[1]);points[paths].push(self.convertCoordScreenToReal(coord,$img));points[paths].color=self.strokeColor;self.markupStarted();},drawMove:function(e,context,getCoordFunc,$img){if(self.paint){e.preventDefault();var coord=getCoordFunc(e);context.lineTo(coord[0],coord[1]);context.stroke();self.model.points[self.model.paths].push(self.convertCoordScreenToReal(coord,$img));}},initForDesktop:function(c,$img){var context=c.getContext("2d");var getCoord=function(evt){var topPanelHeight=$(window).innerWidth()>self.SMALL_SCREEN_WIDTH?self.DEFAULT_TOP_PANEL_HEIGHT:self.SMALL_SCREEN_TOP_PANEL_HEIGHT;var x=evt.pageX-c.offsetLeft-self.canvasOffsetX+$img.width()/2;var y=evt.pageY-c.offsetTop-topPanelHeight+$img.height()/2;return[x,y];};c.addEventListener("mousedown",function(e){self.drawStart(e,context,getCoord,$img);},true);c.addEventListener("mouseenter",function(e){if(self.mouseDown){self.drawStart(e,context,getCoord,$img);}},true);c.addEventListener("mousemove",function(e){if(self.paint){self.drawMove(e,context,getCoord,$img);}},true);c.addEventListener("mouseleave",function(e){self.endPaint();},true);$(document).mousedown(function(e){self.mouseDown=true;});$(document).mouseup(function(e){self.mouseDown=false;self.endPaint();});},initForMobile:function(c,$img){var context=c.getContext("2d");var getCoord=function(e){var topPanelHeight=$(window).innerWidth()>self.SMALL_SCREEN_WIDTH?self.DEFAULT_TOP_PANEL_HEIGHT:self.SMALL_SCREEN_TOP_PANEL_HEIGHT;var x=e.touches[0].pageX-c.offsetLeft-self.canvasOffsetX+$img.width()/2;var y=e.touches[0].pageY-c.offsetTop-topPanelHeight+$img.height()/2;return[x,y];};c.addEventListener("touchmove",function(e){self.paint=true;self.drawMove(e,context,getCoord,$img);},true);c.addEventListener("touchstart",function(e){self.drawStart(e,context,getCoord,$img);},true);c.addEventListener("touchend",self.endPaint,true);},setContextStyles:function(context){context.fillStyle=self.strokeColor;context.strokeStyle=self.strokeColor;context.lineJoin=self.model.LINE_JOIN;context.lineCap=self.model.LINE_CAP;context.lineWidth=self.calculateStrokeWidth();},calculateStrokeWidth:function(){var $img=self.$el.find("#imgPreviewPicture");if($img.length==0){return;}var minDimension=Math.min($img.width(),$img.height());return Math.round(Math.max(minDimension/this.model.STROKE_WIDTH_COEFFICIENT,1));}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.MarkupView;}}).call(window,jQuery,_,Backbone,window.i18n);(function($,_,Backbone,i18n,scrollFixModule){var appRoot=this;appRoot.ImageToolkit=appRoot.ImageToolkit||{};appRoot.ImageToolkit.Views||(appRoot.ImageToolkit.Views={});appRoot.ImageToolkit.Views.TopPanelView=Backbone.BindedView.extend({template:appRoot.JST["ui/presentation/components/image.toolkit/jst/top.panel.template.hbs"],tagName:"div",className:"topPanelContainer",initializeView:function(arg){var self=this;$(document).on("keyup",function(evt){if(evt.keyCode==27){self.close();}});if(window.appRoot&&window.appRoot.isDevice()){return;}if(window.FU_Utils.isSafari()){if(!this.model.fromGallery){$(window).on("popstate",function(e){self.model.set("hasUnsavedData",self.model.mainUtil.model.get("hasUnsavedData"));self.close();});}$(window).on("beforeunload",function(){self.model.mainUtil.model.set("hasUnsavedData",false);});}else{$(window).on("beforeunload",function(){if(self.model.get("hasUnsavedData")&&!self.model.get("close")){return window.fileUploadTranslations.closeGalleryConfirm;}return;});}},renderView:function(){var options=$.extend(this.model.get("currentImage"),window.fileUploadTranslations);this.$el.html(this.template(options));},customBindings:{".topPanelAnswerTitle":{observe:"currentImage",update:function($el,val,model,options){$el.text(val.alt);}},".galleryCloseButton":{observe:"close",update:function($el,val,model,options){if(val){this.restoreBody();}}}},events:{"click .galleryCloseButton":"close"},close:function(){if(this.model.get("disabled")){return;}if(this.model.get("hasUnsavedData")){if(confirm(window.fileUploadTranslations.closeGalleryConfirm)){this.model.mainUtil.model.set("hasUnsavedData",false);this.restoreBody();}else{if(window.FU_Utils.isSafari()){history.pushState("gallery","");}}}else{this.restoreBody();}},restoreBody:function(){$(".imageDrawingContainer").remove();$(".topPanelContainer").remove();$(".galleryToolbar").remove();$(".imageViewContainer").addClass("hidden");$(document.body).removeClass("unscrollable");$("#main_frame").removeClass("unscrollable");$("#formBackCont").removeClass("hidden");window.scroll(0,this.model.getShift());this.eventsOff();scrollFixModule.enableScroll();this.eventsOff();this.model.mainUtil.removeMainView();},eventsOff:function(){$(document).off("keyup");$(window).off("resize");$(window).off("orientationchange.gallery");$(window).off("popstate");}});if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=appRoot.ImageToolkit.Views.TopPanelView;}}).call(window,jQuery,_,Backbone,window.i18n,window.scrollFixModule);